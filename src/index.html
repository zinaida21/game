<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap"
            rel="stylesheet" />
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <section class="game">
            <div class="level">
                <p class="level__title">Выбери сложность</p>
                <div class="level__buttons">
                    <div
                        class="level__button--num level__button--1"
                        data-order="1">
                        1
                    </div>
                    <div
                        class="level__button--num level__button--2"
                        data-order="2">
                        2
                    </div>
                    <div
                        class="level__button--num level__button--3"
                        data-order="3">
                        3
                    </div>
                </div>
                <button class="btn level__button--start">Старт</button>
            </div>

            <div class="game__wrapper">
                <div class="top">
                    <div class="timer">00:00</div>
                    <button class="btn btn--over">Начать заново</button>
                </div>
                <div class="cards"></div>
            </div>
        </section>
        <div class="popup popup-win">
            <!---<img src="../img/Image-win.svg" alt="img" class="popup__img" />-->
            <div class="popup-win__img"></div>
            <p class="popup__title">Вы выиграли!</p>
            <p class="popup__title--time">Затраченное время:</p>
            <div class="time">
                <div class="timer timer__win">00:00</div>
            </div>
            <button class="btn popup__btn popup--over">Играть снова</button>
        </div>

        <div class="popup popup-losing">
            <div class="popup-los__img"></div>
            <!---<img src="../img/Image-losing.svg" alt="img" class="popup__img" />-->
            <p class="popup__title">Вы проиграли!</p>
            <p class="popup__title--time">Затраченное время:</p>
            <div class="time">
                <div class="timer timer__los">00:00</div>
            </div>
            <button class="btn popup__btn popup--over">Играть снова</button>
        </div>

        <script>
            const buttonsParent = document.querySelector('.level__buttons');
            const buttonsLevel = document.querySelectorAll(
                '.level__button--num'
            );
            const level = document.querySelector('.level');
            const buttonStart = document.querySelector('.level__button--start');
            const gameField = document.querySelector('.game__wrapper');
            const cards = document.querySelector('.cards');
            const popupLosing = document.querySelector('.popup-losing');
            const popupWin = document.querySelector('.popup-win');

            //активная кнопка уровня
            for (let i = 0; i < buttonsLevel.length; i++) {
                buttonsLevel[i].addEventListener(
                    'click',
                    function levelSelection() {
                        [...buttonsLevel].forEach((el) =>
                            el.classList.remove('active')
                        );
                        this.classList.add('active');
                    }
                );

                //выбор уровня
                buttonStart.addEventListener('click', function () {
                    if (buttonsLevel[i].classList.contains('active')) {
                        let buttonData =
                            buttonsLevel[i].getAttribute('data-order');
                        console.log(buttonData + 'класс актив');

                        if (buttonData === '1') {
                            timer();
                            lowLevel();
                        }
                        if (buttonData === '2') {
                            timer();
                            middleLevel();
                        }
                        if (buttonData === '3') {
                            timer();
                            highLevel();
                        }
                    }
                });
            }

            //1 уровень
            function lowLevel() {
                console.log('1 уровень');
                level.style.display = 'none';
                gameField.style.display = 'block';

                createCardSet(6);

                //когда карты выложны на столе - запустим обработчик нажатий на карту
                cardClickHandler();

                return;
            }

            //2 уровень
            function middleLevel() {
                console.log('2 уровень');
                level.style.display = 'none';
                gameField.style.display = 'block';

                createCardSet(12);
                //когда карты выложны на столе - запустим обработчик нажатий на карту
                cardClickHandler();

                return;
            }

            //3 уровень
            function highLevel() {
                console.log('3 уровень');
                level.style.display = 'none';
                gameField.style.display = 'block';

                createCardSet(18);
                //когда карты выложны на столе - запустим обработчик нажатий на карту
                cardClickHandler();
                return;
            }

            function createCardSet(numCards) {
                //создадим массив из 6 карт
                const cardArr = Array.from(Array(numCards), () =>
                    createCard('card')
                );

                //создадим клон нашего массива
                const clonedArr = cardArr.map((card) => card.cloneNode());

                //создадим набор карт, содержащий в себе повторяющийся массив наших карт
                const cardsSet = [...cardArr, ...clonedArr];

                //перемешаем набор случайным образом
                cardsSet
                    .map((value) => ({ value, sort: Math.random() }))
                    .sort((a, b) => a.sort - b.sort)
                    .map(({ value }) => value);

                //разложим массив на игровом поле
                cardsSet.forEach((card) => {
                    cards.appendChild(card);
                });

                return cardsSet;
            }

            let hasFlippedCard = false; //если карта не перевернута
            let lockBoard = false; //если нажата вторая карта
            let firstCard, secondCard;

            function flipCardClick() {
                if (lockBoard) return;
                if (this === firstCard) return;
                this.classList.remove('flip');

                if (!hasFlippedCard) {
                    hasFlippedCard = true;
                    firstCard = this;
                    console.log(firstCard.dataset.name);
                    //console.log(this.dataset.name);
                    return;
                }

                //при нажатии на 2ю карту попадаем в блок else
                secondCard = this;
                lockBoard = true;
                //hasFlippedCard = false;
                console.log(secondCard.dataset.name);
                //console.log(firstCard.dataset.name);
                checkForMatch();

                getResult();
            }

            //получение результата
            function getResult() {
                if (document.querySelectorAll('.card.flip').length === 0) {
                    console.log('game over');
                    popupWin.style.display = 'flex';
                    gameField.style.display = 'none';
                    clearTimeout(timerRun);
                }
                return;
            }

            //сравнение карт
            function checkForMatch() {
                let isMatch =
                    firstCard.dataset.name === secondCard.dataset.name;
                isMatch ? disableCards() : unflipCards();
            }

            function disableCards() {
                firstCard.removeEventListener('click', flipCardClick);
                secondCard.removeEventListener('click', flipCardClick);

                resetBoard();
            }

            function unflipCards() {
                //lockBoard = true;
                setTimeout(() => {
                    firstCard.classList.add('flip');
                    secondCard.classList.add('flip');
                    //lockBoard = false;
                    resetBoard();
                }, 1500);
            }

            function resetBoard() {
                [hasFlippedCard, lockBoard] = [false, false];
                [firstCard, secondCard] = [null, null];
            }

            function createCard(className) {
                //console.log(arrNewCard);
                let newCard = document.createElement('div');

                //рандомное число для data
                let ramdomPos = Math.floor(Math.random() * 36);
                //newCard.style.order = arrNewCard();
                newCard.className = className;
                newCard.classList.add('card');
                newCard.setAttribute('data-name', ramdomPos);

                return newCard;
            }

            function cardClickHandler() {
                const cardsAll = document.querySelectorAll('.card');
                //показать все карты затем через 4 сек перевернуть рубашкой вверх
                function flipCard(card) {
                    card.classList.add('flip');
                }

                cardsAll.forEach((card) => {
                    card.addEventListener('click', flipCardClick);
                    setTimeout(() => flipCard(card), 4000);
                });
            }

            //кнопка начать заново
            const startOver = document.querySelectorAll('.popup--over');
            const startGame = document.querySelector('.btn--over');
            for (let i = 0; i < startOver.length; i++) {
                startOver[i].addEventListener('click', function () {
                    level.style.display = 'flex';
                    gameField.style.display = 'none';
                    popupLosing.style.display = 'none';
                    popupWin.style.display = 'none';
                    location.reload();
                });
            }

            startGame.addEventListener('click', function () {
                location.reload();
            });

            let timerRun;
            //функция таймера
            function startTimer(duration, display) {
                let timer = duration,
                    minutes,
                    seconds;
                timerRun = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);

                    minutes = minutes < 10 ? '0' + minutes : minutes;
                    seconds = seconds < 10 ? '0' + seconds : seconds;

                    display.textContent = minutes + ':' + seconds;
                    display2.textContent = minutes + ':' + seconds;
                    display3.textContent = minutes + ':' + seconds;

                    if (++timer < 0) {
                        timer = duration;
                    }
                }, 1000);
            }

            /*window.onload = function () {
                let fiveMinutes = 0,
                    display = document.querySelector('.timer');
                startTimer(fiveMinutes, display);
            };*/

            function timer() {
                let fiveMinutes = 0;
                display = document.querySelector('.timer');
                display2 = document.querySelector('.timer__win');
                display3 = document.querySelector('.timer__los');

                startTimer(fiveMinutes, display);
            }
        </script>
    </body>
</html>
